<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Vídeos Automatizados</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {--dark-900: #0A0A0A; --dark-800: #1A1A1A; --dark-700: #252525; --dark-600: #333333; --gray-500: #666666; --gray-400: #999999; --gray-200: #CCCCCC; --gray-50: #F0F0F0; --accent-500: #6D28D9; --accent-600: #5B21B6; --accent-400: #8B5CF6;}
        * {box-sizing: border-box; margin: 0; padding: 0;}
        body {font-family: 'Inter', sans-serif; background-color: var(--dark-900); color: var(--gray-200); min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 2rem; background-image: radial-gradient(circle at 25% 25%, rgba(109, 40, 217, 0.1) 0%, transparent 50%), radial-gradient(circle at 75% 75%, rgba(109, 40, 217, 0.1) 0%, transparent 50%);}
        .container {width: 100%; max-width: 800px; animation: fadeIn 0.5s ease-out;}
        @keyframes fadeIn {from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); }}
        .header {text-align: center; margin-bottom: 2.5rem;}
        .header h1 {font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; background: linear-gradient(90deg, #FFFFFF, var(--accent-400)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.05em;}
        .header p {color: var(--gray-400); font-size: 1.1rem; max-width: 600px; margin: 0 auto;}
        .video-form { }
        .video-panel {background-color: var(--dark-800); border-radius: 16px; padding: 2.5rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); border: 1px solid var(--dark-600); display: grid; gap: 1.75rem; margin-bottom: 2rem;}
        .form-errors { border: 1px solid #e53e3e; background-color: rgba(229, 62, 62, 0.1); padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; color: #f56565; font-size: 0.95rem; }
        .form-errors h4 { margin-top: 0; margin-bottom: 1rem; color: white; }
        .form-errors ul { list-style-position: inside; padding-left: 0.5rem; margin: 0; }
        .form-errors li { margin-bottom: 0.5rem; }
        .form-section {display: grid; gap: 1.75rem;}
        .form-section-title {color: var(--gray-50); font-weight: 600; font-size: 1.1rem; margin-bottom: -0.5rem; display: flex; align-items: center; gap: 0.5rem;}
        .form-section-title::before {content: ""; display: block; width: 8px; height: 8px; background-color: var(--accent-500); border-radius: 50%;}
        .form-field {display: grid; gap: 0.6rem;}
        .form-row {display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;}
        .form-row-3 {display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem;}
        label {font-weight: 500; color: var(--gray-400); font-size: 0.95rem; letter-spacing: 0.01em;}
        input, select, textarea {padding: 1rem 1.2rem; background-color: var(--dark-700); border: 1px solid var(--dark-600); border-radius: 10px; color: white; font-size: 0.95rem; transition: all 0.25s ease; width: 100%;}
        input:focus, select:focus, textarea:focus {outline: none; border-color: var(--accent-500); box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.3);}
        textarea {min-height: 120px; resize: vertical; line-height: 1.5;}
        .checkbox-group {display: flex; flex-wrap: wrap; gap: 1rem;}
        .checkbox-field, .radio-field {display: flex; align-items: center; gap: 0.7rem;}
        .checkbox-field input[type="checkbox"], .radio-field input[type="radio"] {-webkit-appearance: none; appearance: none; width: 18px; height: 18px; border: 2px solid var(--dark-600); background-color: var(--dark-700); cursor: pointer; position: relative; transition: all 0.2s; flex-shrink: 0;}
        .checkbox-field input[type="checkbox"] { border-radius: 4px; }
        .radio-field input[type="radio"] { border-radius: 50%; }
        .checkbox-field input[type="checkbox"]:checked, .radio-field input[type="radio"]:checked {background-color: var(--accent-500); border-color: var(--accent-500);}
        .checkbox-field input[type="checkbox"]:checked::after {content: "✓"; position: absolute; color: white; font-size: 12px; top: 50%; left: 50%; transform: translate(-50%, -50%);}
        .radio-field input[type="radio"]:checked::after { content: ""; position: absolute; background: white; width: 8px; height: 8px; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%);}
        .checkbox-field label, .radio-field label {font-weight: 400; cursor: pointer; user-select: none;}
        .radio-selector ul { list-style: none; display: flex; gap: 1.5rem; padding: 0;}
        .radio-selector li { margin: 0; }
        .btn {cursor: pointer; padding: 1rem 1.5rem; border: none; border-radius: 10px; font-weight: 600; font-size: 1rem; transition: all 0.25s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn:disabled { cursor: not-allowed; background-color: var(--dark-600); color: var(--gray-500); }
        .btn-primary {background-color: var(--accent-500); color: white;}
        .btn-primary:not(:disabled):hover {background-color: var(--accent-600); transform: translateY(-2px); box-shadow: 0 5px 20px rgba(109, 40, 217, 0.3);}
        .btn-secondary {background-color: var(--dark-700); color: var(--gray-200);}
        .btn-secondary:not(:disabled):hover {background-color: var(--dark-600);}
        .actions-bar { display: flex; gap: 1rem; margin-top: 1rem; }
        .divider {border: none; border-top: 1px solid var(--dark-600); margin: 0;}
        .voice-preview {display: flex; align-items: center; gap: 1rem;}
        .voice-preview select {flex: 1;}
        .secao-conteudo, .opcoes-texto, .opcoes-narracao { display: none; }
        @media (max-width: 768px) {.form-row, .form-row-3 {grid-template-columns: 1fr;} body {padding: 1.5rem;} .video-panel {padding: 1.5rem;} .header h1 {font-size: 2rem;}}
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Gerador de Vídeos Automatizados</h1>
            <p>Crie até 3 vídeos profissionais em escala com apenas um envio.</p>
        </header>

        <form class="video-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ formset.management_form }}

            <div id="form-container">
                {% for form in formset %}
                <div class="video-panel" data-panel-id="{{ forloop.counter0 }}">
                    
                    {% if form.errors %}
                        <div class="form-errors">
                            <h4>Por favor, corrija os erros abaixo:</h4>
                            {{ form.non_field_errors }}
                            <ul>
                            {% for field in form %}
                                {% if field.errors %}
                                    <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
                                {% endif %}
                            {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <div class="form-section">
                        <h3 class="form-section-title">1. Tipo de Conteúdo</h3>
                        <div class="form-field radio-selector">
                            {{ form.tipo_conteudo }}
                        </div>
                    </div>
                    <div class="divider"></div>
                    
                    <div class="secao-conteudo" data-content-type="estatico">
                        <div class="form-section">
                            <h3 class="form-section-title">2. Conteúdo do Texto Estático</h3>
                            <div class="form-field">{{ form.texto_overlay.label_tag }} {{ form.texto_overlay }}</div>
                            <div class="form-field">{{ form.duracao_segundos.label_tag }} {{ form.duracao_segundos }} <small class="form-text text-muted">{{ form.duracao_segundos.help_text }}</small></div>
                        </div>
                    </div>
                    
                    <div class="secao-conteudo" data-content-type="narrador">
                        <div class="form-section">
                            <h3 class="form-section-title">2. Conteúdo da Narração</h3>
                            <div class="form-field">{{ form.narrador_texto.label_tag }} {{ form.narrador_texto }}</div>
                            <div class="checkbox-field">{{ form.legenda_sincronizada }} <label for="{{ form.legenda_sincronizada.id_for_label }}">{{ form.legenda_sincronizada.label }}</label></div>
                        </div>
                    </div>
                    
                    <div class="opcoes-texto">
                        <div class="divider"></div>
                        <div class="form-section">
                            <h3 class="form-section-title">3. Estilo do Texto</h3>
                            <div class="form-field">
                                <label>{{ form.posicao_texto.label }}</label>
                                <div class="radio-selector">
                                    {{ form.posicao_texto }}
                                </div>
                            </div>
                            <div class="form-row-3">
                                <div class="form-field">{{ form.cor_da_fonte.label_tag }} {{ form.cor_da_fonte }}</div>
                                <div class="form-field">{{ form.texto_fonte.label_tag }} {{ form.texto_fonte }}</div>
                                <div class="form-field">{{ form.texto_tamanho.label_tag }} {{ form.texto_tamanho }}</div>
                            </div>
                            <div class="form-field"><label>Formatos:</label><div class="checkbox-group"><div class="checkbox-field">{{ form.texto_negrito }} <label for="{{ form.texto_negrito.id_for_label }}">{{ form.texto_negrito.label }}</label></div><div class="checkbox-field">{{ form.texto_sublinhado }} <label for="{{ form.texto_sublinhado.id_for_label }}">{{ form.texto_sublinhado.label }}</label></div></div></div>
                        </div>
                    </div>

                    <div class="opcoes-narracao">
                        <div class="divider"></div>
                         <div class="form-section">
                            <h3 class="form-section-title">4. Opções da Voz</h3>
                            <div class="form-field"><label for="{{ form.narrador_voz.id_for_label }}">{{ form.narrador_voz.label }}</label><div class="voice-preview">{{ form.narrador_voz }}<button type="button" class="btn btn-secondary play-voice-preview-btn">Ouvir</button></div></div>
                            <div class="form-row">
                                <div class="form-field">{{ form.narrador_velocidade.label_tag }} {{ form.narrador_velocidade }}</div>
                                <div class="form-field">{{ form.narrador_tom.label_tag }} {{ form.narrador_tom }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="divider"></div>

                    <div class="form-section">
                        <h3 class="form-section-title">5. Mídia de Fundo e Encerramento</h3>
                        <div class="form-row">
                            <div class="form-field">{{ form.categoria_video.label_tag }} {{ form.categoria_video }}</div>
                            <div class="form-field">{{ form.categoria_musica.label_tag }} {{ form.categoria_musica }}</div>
                        </div>
                        <div class="form-row">
                           <div class="form-field">{{ form.volume_musica.label_tag }} {{ form.volume_musica }}</div>
                            <div class="checkbox-field" style="align-self: end; padding-bottom: 0.5rem;">{{ form.loop_video }} <label for="{{ form.loop_video.id_for_label }}">{{ form.loop_video.label }}</label></div>
                        </div>
                        <div class="form-field">
                            {{ form.texto_tela_final.label_tag }}
                            {{ form.texto_tela_final }}
                            <small class="form-text text-muted">{{ form.texto_tela_final.help_text }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div id="empty-form-template" style="display: none;"></div>
            
            <div class="actions-bar">
                <button type="submit" class="btn btn-primary">Gerar Vídeos</button>
                <button type="button" id="add-form-btn" class="btn btn-secondary">Adicionar Outro Vídeo</button>
            </div>
        </form>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        function setupPanel(panel) {
            const radioButtons = panel.querySelectorAll('input[name$="-tipo_conteudo"]');
            const secaoEstatico = panel.querySelector('[data-content-type="estatico"]');
            const secaoNarrador = panel.querySelector('[data-content-type="narrador"]');
            const opcoesTexto = panel.querySelector('.opcoes-texto');
            const opcoesNarracao = panel.querySelector('.opcoes-narracao');
            const textoOverlayInput = panel.querySelector('[name$="-texto_overlay"]');
            const legendaCheckbox = panel.querySelector('[name$="-legenda_sincronizada"]');

            function toggleSections() {
                const selectedType = panel.querySelector('input[name$="-tipo_conteudo"]:checked').value;
                const showEstatico = selectedType === 'estatico';
                const showNarrador = selectedType === 'narrador';
                
                secaoEstatico.style.display = showEstatico ? 'grid' : 'none';
                secaoNarrador.style.display = showNarrador ? 'grid' : 'none';
                opcoesNarracao.style.display = showNarrador ? 'block' : 'none';
                
                const hasStaticText = textoOverlayInput.value.trim() !== '';
                const hasKaraoke = legendaCheckbox.checked;
                // LÓGICA CORRIGIDA: A seção de estilo aparece se for texto estático OU narração com karaokê.
                opcoesTexto.style.display = (showEstatico && hasStaticText) || (showNarrador && hasKaraoke) ? 'block' : 'none';
            }
            
            panel.querySelectorAll('input, textarea, select').forEach(el => {
                el.addEventListener('input', toggleSections);
                el.addEventListener('change', toggleSections);
            });
            
            toggleSections();
        }

        document.querySelectorAll('.video-panel').forEach(setupPanel);

        const addFormBtn = document.getElementById('add-form-btn');
        const formContainer = document.getElementById('form-container');
        const totalFormsInput = document.querySelector('#id_form-TOTAL_FORMS');
        const maxForms = parseInt(document.querySelector('#id_form-MAX_NUM_FORMS').value);
        let formTemplateHTML = document.querySelector('.video-panel').innerHTML;

        function updateAddButtonState() {
            const currentFormCount = formContainer.querySelectorAll('.video-panel').length;
            addFormBtn.disabled = currentFormCount >= maxForms;
            addFormBtn.textContent = currentFormCount >= maxForms ? 'Máximo de vídeos atingido' : 'Adicionar Outro Vídeo';
        }

        addFormBtn.addEventListener('click', function() {
            const currentFormCount = formContainer.querySelectorAll('.video-panel').length;
            if (currentFormCount < maxForms) {
                const newFormHtml = formTemplateHTML.replace(/form-0/g, `form-${currentFormCount}`);
                const newPanel = document.createElement('div');
                newPanel.className = 'video-panel';
                newPanel.setAttribute('data-panel-id', currentFormCount);
                newPanel.innerHTML = newFormHtml;
                
                const errorBox = newPanel.querySelector('.form-errors');
                if (errorBox) errorBox.remove();
                
                formContainer.appendChild(newPanel);
                setupPanel(newPanel);
                totalFormsInput.value = currentFormCount + 1;
                updateAddButtonState();
            }
        });
        
        let audioPlayer = new Audio();
        document.body.addEventListener('click', function(event) {
            const button = event.target.closest('.play-voice-preview-btn');
            if (!button || button.disabled) return;
            const panel = button.closest('.video-panel');
            const voiceSelect = panel.querySelector('select[name$="-narrador_voz"]');
            const selectedVoice = voiceSelect.value;
            if (selectedVoice) {
                const previewUrl = `/preview-voz/${selectedVoice}/`;
                const originalButtonContent = button.innerHTML;
                button.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="animate-spin" style="margin-right: 4px;"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM12 19C8.13401 19 5 15.866 5 12C5 8.13401 8.13401 5 12 5C15.866 5 19 8.13401 19 12C19 15.866 15.866 19 12 19Z" fill="currentColor" opacity="0.3"/><path d="M12 2C6.47715 2 2 6.47715 2 12C2 13.8214 2.48697 15.5291 3.33782 17L4.26777 15.7322C3.61305 14.5894 3.2 13.3188 3.2 12C3.2 7.13989 7.13989 3.2 12 3.2C16.8601 3.2 20.8 7.13989 20.8 12C20.8 13.3188 20.387 14.5894 19.7322 15.7322L20.6622 17C21.513 15.5291 22 13.8214 22 12C22 6.47715 17.5228 2 12 2Z" fill="currentColor"/></svg> Carregando...`;
                button.disabled = true;
                audioPlayer.src = previewUrl;
                audioPlayer.play().catch(e => console.error("Erro ao tocar áudio:", e));
                const onAudioEnd = () => {
                    button.innerHTML = originalButtonContent;
                    button.disabled = false;
                    audioPlayer.removeEventListener('ended', onAudioEnd);
                    audioPlayer.removeEventListener('error', onAudioEnd);
                };
                audioPlayer.addEventListener('ended', onAudioEnd);
                audioPlayer.addEventListener('error', onAudioEnd);
            }
        });
        
        updateAddButtonState();
    });
    </script>
</body>
</html>